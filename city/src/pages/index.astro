---
---

<html>
<head>
  <title>World Explorer</title>
  <link rel="stylesheet" href="/styles.css">
</head>

<body>
<div class="bento">

  <div class="box" id="logo" style="grid-area:logo">
    <h1>CITY ONEGAISHIMASU</h1>
  </div>

  <div class="box" id="place" style="grid-area:place">
    <p id="countryLabel"></p>
    <h2 id="cityLabel"></h2>
  </div>

  <div class="box" id="searchBox" style="grid-area:search">
    <input id="cityInput" placeholder="Search city..." autocomplete="off" />
    <div id="suggestions"></div>
  </div>

  <div class="box" id="weather" style="grid-area:weather"></div>

  <div class="box" id="scene" style="grid-area:scene">
    <img id="scenicImg" />
  </div>

  <div class="box" id="arch" style="grid-area:arch">
    <div id="archGrid"></div>
  </div>

  <div class="box" id="ppl" style="grid-area:ppl">
    <div id="dressGrid"></div>
  </div>

  <div class="box" id="food" style="grid-area:food">
    <div id="foodGrid"></div>
  </div>

  <div class="box" id="song1" style="grid-area:song1">
    <div id="musicTrack1"></div>
  </div>

  <div class="box" id="song2" style="grid-area:song2">
    <div id="musicTrack2"></div>
  </div>

</div>

<script>
const API_BASE = "http://localhost:8000";
const cityInput   = document.getElementById("cityInput");
const suggestions = document.getElementById("suggestions");
let debounceTimer = null;

// ── Autocomplete ──────────────────────────────────────────
cityInput.addEventListener("input", () => {
  clearTimeout(debounceTimer);
  const q = cityInput.value.trim();
  if (q.length < 2) { suggestions.innerHTML = ""; return; }

  debounceTimer = setTimeout(async () => {
    try {
      const res  = await fetch(`${API_BASE}/autocomplete?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      renderSuggestions(data.suggestions || []);
    } catch {
      suggestions.innerHTML = "";
    }
  }, 300);
});

function renderSuggestions(cities) {
  suggestions.innerHTML = cities.map(c => `
    <div class="suggestion-item"
         data-name="${c.name}"
         data-country="${c.country}"
         data-code="${c.countryCode}">
      ${c.name}, ${c.country}
    </div>
  `).join("");

  suggestions.querySelectorAll(".suggestion-item").forEach(item => {
    item.addEventListener("click", () => {
      cityInput.value = `${item.dataset.name}, ${item.dataset.country}`;
      suggestions.innerHTML = "";
      loadCity(item.dataset.name, item.dataset.country, item.dataset.code);
    });
  });
}

// ── Load all data ─────────────────────────────────────────
async function loadCity(name, country, countryCode) {
  // Loading states
  document.getElementById("weather").innerHTML    = `<p class="loading">Loading...</p>`;
  document.getElementById("archGrid").innerHTML   = `<p class="loading">Loading...</p>`;
  document.getElementById("dressGrid").innerHTML  = `<p class="loading">Loading...</p>`;
  document.getElementById("foodGrid").innerHTML   = `<p class="loading">Loading...</p>`;
  document.getElementById("musicTrack1").innerHTML = `<p class="loading">Loading...</p>`;
  document.getElementById("musicTrack2").innerHTML = `<p class="loading">Loading...</p>`;
  document.getElementById("scenicImg").src = "";

  try {
    const res  = await fetch(
      `${API_BASE}/place?name=${encodeURIComponent(name)}&country=${encodeURIComponent(country)}&countryCode=${countryCode}`
    );
    const data = await res.json();

    renderPlace(data.place, data.country);
    renderWeather(data.weather);
    renderScenery(data.scenery);
    renderArchitecture(data.architecture);
    renderFoodPhotos(data.food_photos);
    renderDress(data.dress);
    renderMusic(data.music);

  } catch (err) {
    console.error("Failed to load city data:", err);
  }
}

// ── Renderers ─────────────────────────────────────────────

function renderPlace(city, country) {
  document.getElementById("cityLabel").textContent   = city || "";
  document.getElementById("countryLabel").textContent = country || "";
}

function renderWeather(w) {
  if (!w) { document.getElementById("weather").innerHTML = "<p>Unavailable</p>"; return; }
  document.getElementById("weather").innerHTML = `
    <img src="https://openweathermap.org/img/wn/${w.icon}@2x.png" alt="${w.description}" />
    <h2>${w.temp}°C</h2>
    <p>${w.description}</p>
    <p>Feels like ${w.feels_like}°C</p>
    <p>Humidity: ${w.humidity}%</p>
    <p>Wind: ${w.wind_speed} m/s</p>
  `;
}

// Scenery → big scene box, also sets ambient color
function renderScenery(photos) {
  makeSlideshow("scene", photos, 4000);
  // set ambient color from first photo after slideshow is built
  if (photos?.length) {
    document.body.style.setProperty("--ambient", photos[0].color);
  }
}

function renderArchitecture(photos) {
  makeSlideshow("arch", photos, 3000);
}

function renderFoodPhotos(photos) {
  makeSlideshow("food", photos, 3500);
}

function renderDress(photos) {
  makeSlideshow("ppl", photos, 5000);
}

// Music → split across song1 and song2 boxes
function renderMusic(tracks) {
  const t1 = tracks?.[0];
  const t2 = tracks?.[1];

  document.getElementById("musicTrack1").innerHTML = t1 ? `
    <div class="music-item">
      <img src="${t1.cover}" width="40" height="40" alt="${t1.title}" />
      <div>
        <p>${t1.title}</p>
        <small>${t1.artist}</small>
      </div>
      <audio controls src="${t1.preview}"></audio>
    </div>
  ` : "<p>Unavailable</p>";

  document.getElementById("musicTrack2").innerHTML = t2 ? `
    <div class="music-item">
      <img src="${t2.cover}" width="40" height="40" alt="${t2.title}" />
      <div>
        <p>${t2.title}</p>
        <small>${t2.artist}</small>
      </div>
      <audio controls src="${t2.preview}"></audio>
    </div>
  ` : "<p>Unavailable</p>";
}

const slideshowTimers = {};

function makeSlideshow(containerId, photos, interval = 3000) {
  const container = document.getElementById(containerId);
  if (!photos?.length) { container.innerHTML = "<p>Unavailable</p>"; return; }

  // clear any existing timer for this container if reloading a new city
  if (slideshowTimers[containerId]) {
    clearInterval(slideshowTimers[containerId]);
  }

  container.innerHTML = `
    <div class="slideshow">
      ${photos.map((p, i) => `
        <img src="${p.url}" alt="${p.alt}" class="slide ${i === 0 ? 'active' : ''}" />
      `).join("")}
      <button class="slide-btn prev" onclick="slideMove('${containerId}', -1)">&#8592;</button>
      <button class="slide-btn next" onclick="slideMove('${containerId}', 1)">&#8594;</button>
      <div class="slide-dots">
        ${photos.map((_, i) => `
          <span class="dot ${i === 0 ? 'active' : ''}" onclick="slideTo('${containerId}', ${i})"></span>
        `).join("")}
      </div>
    </div>
  `;

  // auto advance every `interval` ms
  slideshowTimers[containerId] = setInterval(() => {
    slideMove(containerId, 1);
  }, interval);
}

</script>

</body>
</html>